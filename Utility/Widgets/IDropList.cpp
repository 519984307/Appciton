#include <QHBoxLayout>
#include <QKeyEvent>
#include "IButton.h"
#include "IDropList.h"
#include "ComboListPopup.h"

/**************************************************************************************************
 * 构造。
 *************************************************************************************************/
IDropList::IDropList(const QString &title) : LButton(), _popup(NULL), _curIndex(0)
{
    _strList.clear();
    setText(title);

    connect(this, SIGNAL(realReleased()), this, SLOT(_showPopup()));
}

/**************************************************************************************************
 * 析构。
 *************************************************************************************************/
IDropList::~IDropList()
{
    if (_popup)
    {
        delete _popup;
        _popup = NULL;
    }
}

/**************************************************************************************************
 * 添加子项。
 *************************************************************************************************/
void IDropList::addItem(const QString &title)
{
    _strList.append(title);
}

/**************************************************************************************************
 * 添加子项。
 *************************************************************************************************/
void IDropList::addItem(const QStringList &title)
{
    _strList.append(title);
}

/**************************************************************************************************
 * 清空子项。
 *************************************************************************************************/
void IDropList::clearItem()
{
    _strList.clear();
}

/**************************************************************************************************
 * 获取当前项。
 *************************************************************************************************/
int IDropList::currentIndex()
{
    return _curIndex;
}

/**************************************************************************************************
 * 获取总数。
 *************************************************************************************************/
int IDropList::count()
{
    return _strList.count();
}

/**************************************************************************************************
 * 返回指定项的字符串。
 *************************************************************************************************/
QString IDropList::itemText(int index)
{
    if (index >= _strList.count())
    {
        return QString("");
    }

    return _strList.at(index);
}

/**************************************************************************************************
 * 设置当前项。
 *************************************************************************************************/
void IDropList::setCurrentIndex(int index)
{
    if (index >= _strList.count())
    {
        return;
    }

    _curIndex = index;

    emit currentIndexChange(index);
}

/**************************************************************************************************
 * 隐藏事件。
 *************************************************************************************************/
void IDropList::hideEvent(QHideEvent */*e*/)
{
    if (_popup)
    {
        _popup->close();
    }
}

/**************************************************************************************************
 * 显示弹出菜单。
 *************************************************************************************************/
void IDropList::_showPopup()
{
    if (count() <= 0)
    {
        return;
    }

    if (!_popup)
    {
        _popup = new ComboListPopup(this, POPUP_TYPE_DROPLIST);
        _popup->setItemDrawMark(false);
        _popup->setFont(this->font());
        connect(_popup, SIGNAL(destroyed()), this, SLOT(_popupDestroyed()));
    }

    _popup->show();
}

/**************************************************************************************************
 * 弹出关闭时自动销毁, 清空对它的引用。
 *************************************************************************************************/
void IDropList::_popupDestroyed()
{
    _popup = NULL;
}
